<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>HKos Cloud Beta</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root { --bg: #000; --card-bg: #0a0a0a; --neon: #00ff88; --shadow: 0 0 15px rgba(0,255,136,0.5); }
        * { -webkit-tap-highlight-color: transparent; user-select: none; box-sizing: border-box; }
        body, html { margin: 0; padding: 0; background: var(--bg); color: #fff; font-family: 'Arial Black', sans-serif; height: 100vh; overflow: hidden; }
        canvas { position: fixed; top: 0; left: 0; z-index: -1; opacity: 0.15; }
        .app-wrapper { display: flex; flex-direction: column; height: 100vh; padding: 15px 20px 90px; }
        .card { background: var(--card-bg); border-radius: 35px; padding: 25px 20px; text-align: center; border: 1px solid rgba(255,255,255,0.05); margin-bottom: 15px; }
        .hkos-val { font-size: 42px; font-weight: 900; color: var(--neon); text-shadow: var(--shadow); font-family: monospace; }
        .btn-3d { background: var(--neon); color: #000; border: none; padding: 15px; border-radius: 15px; font-weight: 900; font-size: 16px; box-shadow: 0 4px 0 #008844; cursor: pointer; width: 100%; }
        .btn-3d:active { transform: translateY(2px); box-shadow: 0 2px 0 #008844; }
        
        /* –¢–∞–±–ª–∏—Ü–∞ –ª–∏–¥–µ—Ä–æ–≤ */
        .leader-row { display: flex; justify-content: space-between; padding: 12px 15px; border-bottom: 1px solid rgba(0,255,136,0.1); font-family: monospace; font-size: 14px; }
        .leader-row:last-child { border: none; }
        .rank { color: var(--neon); font-weight: 900; margin-right: 10px; }
        .u-id { color: #555; }
        
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 20000; display: none; align-items: center; justify-content: center; opacity: 0; transition: 0.3s; }
        .modal-content { background: #0f0f0f; border: 3px solid var(--neon); border-radius: 40px; padding: 40px 25px; text-align: center; width: 85%; transform: scale(0.8); transition: 0.3s; box-shadow: var(--shadow); }
        .modal-overlay.show { opacity: 1; display: flex; }
        .modal-overlay.show .modal-content { transform: scale(1); }
        .progress-box { width: 100%; background: #111; height: 15px; border-radius: 10px; margin: 20px 0; overflow: hidden; }
        .bar { width: 0%; height: 100%; background: var(--neon); box-shadow: var(--shadow); transition: 0.1s; }
        
        .nav { position: fixed; bottom: 30px; left: 15px; right: 15px; display: flex; justify-content: space-around; padding: 15px; background: rgba(10,10,10,0.98); backdrop-filter: blur(15px); border-radius: 25px; border: 1px solid rgba(255,255,255,0.08); }
        .nav-item { font-size: 10px; font-weight: 900; color: #444; text-transform: uppercase; border: none; background: none; }
        .nav-item.active { color: var(--neon); text-shadow: var(--shadow); }
        
        .screen { display: none; flex-direction: column; height: 100%; }
        .screen.active { display: flex; }
        input { background: transparent; border: none; color: var(--neon); text-align: center; width: 100%; outline: none; font-weight: 900; font-size: 18px; text-shadow: var(--shadow); }
        #ban-screen { position: fixed; inset: 0; background: #000; z-index: 30000; display: none; flex-direction: column; align-items: center; justify-content: center; padding: 20px; }
    </style>
</head>
<body>
<canvas id="matrix"></canvas>

<div id="m-reward" class="modal-overlay"><div class="modal-content"><div>üíé</div><h2 style="font-weight:900">–£–°–ü–ï–•!</h2><div id="reward-amt" style="font-size:28px;color:var(--neon);font-weight:900;margin:20px 0">+0.0000 HKos</div><button class="btn-3d" onclick="closeM('m-reward')">–ó–ê–ë–†–ê–¢–¨</button></div></div>
<div id="m-promo" class="modal-overlay"><div class="modal-content"><div>üîë</div><h2 style="font-weight:900">–ê–ö–¢–ò–í–ê–¶–ò–Ø</h2><div id="promo-val-text" style="font-size:28px;color:var(--neon);font-weight:900;margin:20px 0">+0.0000 HKos</div><button class="btn-3d" onclick="closeM('m-promo')">–û–¢–õ–ò–ß–ù–û</button></div></div>

<div id="ban-screen"><h1 style="color:#ff3e3e;font-weight:900">SYSTEM BLOCKED</h1><p style="color:#555">SECURITY ALERT: HIGH CPS</p><input type="text" id="adm-unlock" placeholder="CODE" oninput="checkAdm()" style="margin-top:30px"></div>

<div class="app-wrapper">
    <div id="home-screen" class="screen active">
        <div class="card">
            <div style="font-size:10px;color:#444;font-weight:900" id="user-display-id">–ó–ê–ì–†–£–ó–ö–ê...</div>
            <div id="hk-num" class="hkos-val">0.00000000</div>
            <div id="ps-num" style="font-size:13px;color:#555">0.00000 HK/s</div>
        </div>
        <div id="p-area" class="card" style="padding:15px;border:2px dashed #111;"><input type="text" id="p-input" placeholder="–í–í–ï–î–ò–¢–ï –ü–†–û–ú–û–ö–û–î" oninput="checkPr()"></div>
        <div style="overflow-y:auto;flex:1;padding-bottom:20px;">
            <div class="card" style="display:flex;justify-content:space-between;align-items:center;padding:15px;margin-bottom:10px;"><div><b>–°–õ–ê–ë–´–ô</b><br><small style="color:var(--neon)">+0.07/—á</small></div><button class="btn-3d" style="width:90px" onclick="buy(3, 0.07)">3 HK</button></div>
            <div class="card" style="display:flex;justify-content:space-between;align-items:center;padding:15px;margin-bottom:10px;"><div><b>–°–†–ï–î–ù–ò–ô</b><br><small style="color:var(--neon)">+0.40/—á</small></div><button class="btn-3d" style="width:90px" onclick="buy(15, 0.4)">15 HK</button></div>
            <div class="card" style="display:flex;justify-content:space-between;align-items:center;padding:15px;margin-bottom:10px;"><div><b>–ú–û–©–ù–´–ô</b><br><small style="color:var(--neon)">+1.50/—á</small></div><button class="btn-3d" style="width:90px" onclick="buy(50, 1.5)">50 HK</button></div>
        </div>
    </div>

    <div id="click-screen" class="screen">
        <div class="card">
            <h2 id="target-txt" style="margin:0;font-weight:900">–¶–ï–õ–¨: 0 / 10</h2>
            <div class="progress-box"><div id="bar" class="bar"></div></div>
            <button class="btn-3d" style="padding:50px;font-size:32px" onclick="tap()">TAP</button>
        </div>
    </div>

    <div id="top-screen" class="screen">
        <div class="card" style="flex:1; overflow-y:auto; padding: 20px 10px;">
            <h2 style="margin-top:0; font-weight:900; color:var(--neon);">TOP ANONYMOUS</h2>
            <div id="leaderboard-list">
                <div style="color:#333; margin-top:50px;">–°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–Ø...</div>
            </div>
        </div>
    </div>

    <div class="nav">
        <button id="n-home" class="nav-item active" onclick="nav('home')">–ì–õ–ê–í–ù–û–ï</button>
        <button id="n-click" class="nav-item" onclick="nav('click')">–ö–õ–ò–ö–ï–†</button>
        <button id="n-top" class="nav-item" onclick="nav('top')">–õ–ò–î–ï–†–´</button>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js";
    import { getDatabase, ref, set, get, child, update, query, orderByChild, limitToLast } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBD-uKyTOd3iXNkisXyCkpgeXYzG4oySHM",
        authDomain: "hkos-project.firebaseapp.com",
        projectId: "hkos-project",
        databaseURL: "https://hkos-project-default-rtdb.europe-west1.firebasedatabase.app",
        storageBucket: "hkos-project.firebasestorage.app",
        messagingSenderId: "956154333649",
        appId: "1:956154333649:web:7f8c5f9e64fe81dc5d78f0"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const tg = window.Telegram.WebApp;
    tg.expand();

    const userId = tg.initDataUnsafe?.user?.id || "local_dev";
    // –ê–Ω–æ–Ω–∏–º–Ω—ã–π ID –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è (User_1234)
    const anonId = "USER_" + String(userId).substring(0, 4) + "...";
    document.getElementById('user-display-id').innerText = anonId;

    const _S = {
        a: ["L9Ch0J3QrNCi0KzQkdCQ0J0=", "L9Ch0J3QrNCi0KzQnNCj0KI=", "L9Ch0J3QrNCi0KzQndCQNDg="],
        p1: "0KfQm9CV0J3QntCf0J7QotCQ0J0=",
        p2: "TUFOREE="
    };

    let hk = 0, hp = 0.02, si = 0, ib = false, pu = [], lv = Date.now();
    let stp = [10, 15, 20, 30, 50, 80, 100], cc = 0, ct = [];

    async function loadCloud() {
        const dbRef = ref(db);
        try {
            const snap = await get(child(dbRef, `users/${userId}`));
            if (snap.exists()) {
                const d = snap.val();
                hk = d.hk || 0; hp = d.hp || 0.02; si = d.si || 0;
                ib = d.ib || false; pu = d.pu || []; lv = d.lv || Date.now();
                
                let diff = Math.floor((Date.now() - lv) / 1000);
                if (diff > 60) {
                    let off = Math.min(diff, 5400);
                    let earn = (hp / 3600) * off;
                    hk += earn;
                    tg.showAlert(`–î–æ–±—ã—Ç–æ –≤ –æ—Ñ–ª–∞–π–Ω–µ: ${earn.toFixed(5)} HKos`);
                }
                sync();
            } else { saveCloud(); }
        } catch (e) { console.error(e); }
        loadLeaderboard();
    }

    function saveCloud() {
        update(ref(db, `users/${userId}`), {
            hk: hk, hp: hp, si: si, ib: ib, pu: pu, lv: Date.now(), anon: anonId
        });
    }

    async function loadLeaderboard() {
        const topQuery = query(ref(db, 'users'), orderByChild('hk'), limitToLast(10));
        try {
            const snap = await get(topQuery);
            const list = document.getElementById('leaderboard-list');
            list.innerHTML = "";
            let players = [];
            snap.forEach(child => { players.push(child.val()); });
            players.reverse(); // –ß—Ç–æ–±—ã —Å–∞–º—ã–π –±–æ–≥–∞—Ç—ã–π –±—ã–ª —Å–≤–µ—Ä—Ö—É

            players.forEach((p, index) => {
                const row = document.createElement('div');
                row.className = 'leader-row';
                row.innerHTML = `
                    <span><span class="rank">#${index+1}</span> <span class="u-id">${p.anon || 'Unknown'}</span></span>
                    <span style="font-weight:900;">${parseFloat(p.hk).toFixed(4)}</span>
                `;
                list.appendChild(row);
            });
        } catch (e) { console.error(e); }
    }

    window.tap = function() {
        if(ib) return;
        const n = Date.now(); ct.push(n);
        ct = ct.filter(t => n - t < 1000);
        if(ct.length > 14) { ib = true; saveCloud(); location.reload(); return; }
        
        cc++;
        let t = stp[si] || (100 + (si-6)*20);
        document.getElementById('bar').style.width = (cc/t*100) + "%";
        document.getElementById('target-txt').innerText = `–¶–ï–õ–¨: ${cc} / ${t}`;
        tg.HapticFeedback.impactOccurred('light');

        if(cc >= t) {
            let r = Math.random() < 0.1 ? 0.015 : 0.003;
            hk += r; cc = 0; si++;
            openM('m-reward', "+" + r.toFixed(4) + " HKos");
            sync(); saveCloud();
        }
    };

    window.buy = function(cost, prod) {
        if(hk >= cost) {
            hk -= cost; hp += prod;
            tg.HapticFeedback.notificationOccurred('success');
            sync(); saveCloud();
        } else tg.showAlert("–ú–ê–õ–û HKos");
    };

    window.checkPr = function() {
        let v = document.getElementById('p-input').value.trim().toUpperCase();
        if(!v) return;
        const _dec = (s) => decodeURIComponent(escape(atob(s)));
        if (_S.a.some(a => v === _dec(a))) {
            ib = false; document.getElementById('ban-screen').style.display = 'none';
            document.getElementById('p-input').value = ""; saveCloud(); return;
        }
        let pk = ""; let r = 0;
        if (v === _dec(_S.p1)) { pk = "p1"; r = 5; }
        else if (v === _dec(_S.p2)) { pk = "p2"; r = 10; }
        if (pk) {
            if (pu.includes(pk)) { tg.showAlert("–£–ñ–ï –ò–°–ü–û–õ–¨–ó–û–í–ê–ù–û"); document.getElementById('p-input').value = ""; }
            else {
                hk += r; pu.push(pk); document.getElementById('p-input').value = "";
                openM('m-promo', "+" + r.toFixed(4) + " HKos");
                sync(); saveCloud();
            }
        }
    };

    function sync() {
        document.getElementById('hk-num').innerText = hk.toFixed(8);
        document.getElementById('ps-num').innerText = (hp/3600).toFixed(5) + " HK/s";
        let t = stp[si] || (100 + (si-6)*20);
        document.getElementById('target-txt').innerText = `–¶–ï–õ–¨: ${cc} / ${t}`;
        document.getElementById('bar').style.width = (cc/t*100) + "%";
        if(ib) document.getElementById('ban-screen').style.display = 'flex';
        if(pu.length >= 2) document.getElementById('p-area').style.display = 'none';
    }

    window.nav = (s) => {
        document.querySelectorAll('.screen').forEach(e => e.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(e => e.classList.remove('active'));
        document.getElementById(s + '-screen').classList.add('active');
        document.getElementById('n-' + s).classList.add('active');
        if(s === 'top') loadLeaderboard();
        tg.HapticFeedback.selectionChanged();
    };

    window.closeM = (id) => {
        document.getElementById(id).classList.remove('show');
        setTimeout(() => document.getElementById(id).style.display = 'none', 300);
    };

    function openM(id, txt) {
        if(txt) {
            if(id === 'm-reward') document.getElementById('reward-amt').innerText = txt;
            if(id === 'm-promo') document.getElementById('promo-val-text').innerText = txt;
        }
        document.getElementById(id).style.display = 'flex';
        setTimeout(() => document.getElementById(id).classList.add('show'), 10);
    }

    // –ú–∞—Ç—Ä–∏—Ü–∞
    const cv = document.getElementById('matrix'), cx = cv.getContext('2d');
    cv.width = window.innerWidth; cv.height = window.innerHeight;
    const dr = Array(Math.floor(cv.width/10)).fill(1);
    function draw() {
        cx.fillStyle = "rgba(0,0,0,0.05)"; cx.fillRect(0,0,cv.width,cv.height);
        cx.fillStyle = "#0f8"; cx.font = "10px monospace";
        dr.forEach((y, i) => {
            cx.fillText(Math.random() > 0.5 ? "0" : "1", i*10, y*10);
            if(y*10 > cv.height && Math.random() > 0.975) dr[i] = 0;
            dr[i]++;
        });
    }
    setInterval(draw, 50);

    setInterval(() => { hk += hp/3600/20; sync(); }, 50);
    setInterval(saveCloud, 10000); // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–∞–∑ –≤ 10 —Å–µ–∫ –¥–ª—è —ç–∫–æ–Ω–æ–º–∏–∏ –ª–∏–º–∏—Ç–æ–≤

    loadCloud();
</script>
</body>
</html>
