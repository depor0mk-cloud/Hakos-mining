<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Hakos Mining v40.0</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root { --bg: #000; --neon: #00ff88; --glass: rgba(255, 255, 255, 0.07); --border: rgba(255, 255, 255, 0.1); }
        * { -webkit-tap-highlight-color: transparent; box-sizing: border-box; user-select: none; outline: none; transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); }
        
        body { 
            margin: 0; background: var(--bg); color: #fff; 
            font-family: 'Inter', -apple-system, system-ui, sans-serif;
            overflow: hidden; height: 100vh; 
        }
        
        canvas { position: fixed; inset: 0; z-index: 1; opacity: 0.12; pointer-events: none; }
        .version { position: fixed; bottom: 8px; right: 12px; font-size: 8px; color: rgba(255,255,255,0.1); z-index: 10001; }
        
        #start-screen { position: fixed; inset: 0; background: #000; z-index: 10000; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 30px; text-align: center;}
        .app { position: relative; z-index: 10; display: none; flex-direction: column; height: 100vh; padding: 10px 20px 110px; animation: fadeIn 0.6s ease; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .loader { width: 30px; height: 30px; border: 2px solid var(--glass); border-top-color: var(--neon); border-radius: 50%; animation: spin 0.8s linear infinite; margin-top: 20px; }
        @keyframes spin { to { transform: rotate(360deg); } }

        .lang-capsule { display: flex; align-self: center; background: var(--glass); border: 1px solid var(--border); border-radius: 20px; padding: 3px; margin-bottom: 15px; }
        .lang-btn { background: none; border: none; color: #555; padding: 4px 10px; border-radius: 15px; font-size: 9px; font-weight: 800; cursor: pointer; }
        .lang-btn.active { background: var(--neon); color: #000; }

        .card { background: var(--glass); backdrop-filter: blur(25px); border-radius: 25px; border: 1px solid var(--border); padding: 20px; text-align: center; margin-bottom: 12px; }
        .hk-val { font-size: 34px; font-weight: 800; text-shadow: 0 0 15px rgba(0, 255, 136, 0.3); letter-spacing: -1px; }
        
        .btn-buy { background: var(--neon); color: #000; border: none; padding: 12px 18px; border-radius: 15px; font-weight: 900; font-size: 11px; cursor: pointer; }
        .btn-buy:active { transform: scale(0.94); }
        .btn-buy:disabled { background: #333; color: #666; cursor: not-allowed; }
        
        .tap-pill { width: 100%; height: 160px; background: var(--glass); border-radius: 40px; border: 1px solid var(--border); display: flex; flex-direction: column; align-items: center; justify-content: center; margin: 10px 0; position: relative; overflow: hidden; }
        .tap-pill:active { transform: scale(0.97); background: rgba(0, 255, 136, 0.05); }

        .nav { position: fixed; bottom: 30px; left: 15px; right: 15px; display: flex; justify-content: space-around; background: rgba(10,10,10,0.85); backdrop-filter: blur(20px); padding: 15px 5px; border-radius: 25px; border: 1px solid var(--border); z-index: 5000; }
        .nav-item { color: rgba(255,255,255,0.3); border: none; background: none; font-size: 9px; font-weight: 900; letter-spacing: 0.5px; }
        .nav-item.active { color: var(--neon); }

        .screen { display: none; flex-direction: column; height: 100%; overflow-y: auto; }
        .screen.active { display: flex; }
        
        .leader-row { display: flex; justify-content: space-between; padding: 12px 10px; border-bottom: 1px solid rgba(255,255,255,0.05); font-size: 14px; align-items: center; }
        .leader-row b { color: var(--neon); }
        .me-highlight { background: rgba(0, 255, 136, 0.15) !important; color: var(--neon) !important; border-left: 3px solid var(--neon); }

        .ios-notif { position: fixed; top: -120px; left: 50%; transform: translateX(-50%); width: 85%; background: rgba(20,20,20,0.98); border-radius: 22px; padding: 18px; text-align: center; z-index: 20000; transition: 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275); color: var(--neon); font-weight: bold; border: 1px solid var(--border); box-shadow: 0 15px 40px rgba(0,0,0,0.5); }
        .ios-notif.show { top: 25px; }

        input { background: none; border: none; color: #fff; text-align: center; width: 100%; font-size: 12px; letter-spacing: 2px; }
        .game-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 15px; }
        .grid-cell { height: 70px; background: var(--glass); border: 1px solid var(--border); border-radius: 15px; display: flex; align-items: center; justify-content: center; font-size: 20px; transition: 0.1s; }
        .find-me-btn { width: 100%; background: var(--glass); color: var(--neon); border: 1px solid var(--border); padding: 10px; border-radius: 15px; font-size: 10px; margin-bottom: 15px; font-weight: 900; }
        .boost-tag { font-size: 9px; background: var(--neon); color: #000; padding: 2px 6px; border-radius: 5px; margin-left: 5px; display: none; }
        @keyframes shuffle { 0% { opacity: 1; } 50% { opacity: 0.3; transform: scale(0.95); } 100% { opacity: 1; } }
        .shuffling { animation: shuffle 0.4s ease-in-out; }
    </style>
</head>
<body>

<div class="version">v40.0 HARDCORE</div>
<div id="notif" class="ios-notif"></div>
<canvas id="matrix"></canvas>

<div id="start-screen">
    <div style="font-size: 40px; font-weight: 900; color: var(--neon); letter-spacing: 5px;">HAKOS</div>
    <div id="loader" class="loader"></div>
    <div id="start-cont" style="width: 100%; display: none; margin-top: 20px;">
        <button id="btn-create" onclick="entry('save')" style="background:var(--neon); color:#000; border:none; padding:18px; border-radius:20px; font-weight:900; width:100%; margin-bottom:12px;">–°–û–ó–î–ê–¢–¨ –ê–ö–ö–ê–£–ù–¢</button>
        <button id="btn-demo" onclick="entry('demo')" style="background:rgba(255,255,255,0.05); color:#fff; border:1px solid var(--border); padding:14px; border-radius:18px; font-weight:700; width:100%; margin-bottom:12px;">–î–ï–ú–û-–†–ï–ñ–ò–ú</button>
    </div>
</div>

<div class="app" id="app">
    <div class="lang-capsule">
        <button class="lang-btn active" onclick="setLang('ru')">RU</button>
        <button class="lang-btn" onclick="setLang('ua')">UA</button>
        <button class="lang-btn" onclick="setLang('en')">EN</button>
    </div>

    <div id="home-screen" class="screen active">
        <div class="card">
            <div id="user-display" style="font-size:10px; color:var(--neon); font-weight:800; letter-spacing:2px; margin-bottom:5px; opacity:0.6">ID: ...</div>
            <div id="hk-num" class="hk-val">0.000000</div>
            <div id="ps-num" style="color:var(--neon); font-size:12px; font-weight:700; margin-top:5px; display:flex; align-items:center; justify-content:center;">
                0.00000 HK/s <span id="boost-timer" class="boost-tag">x1.5</span>
            </div>
            <button onclick="shareRef()" id="ref-btn" style="background:rgba(255,255,255,0.03); color:#fff; border:1px solid var(--border); width:100%; padding:14px; border-radius:18px; font-size:11px; margin-top:15px; font-weight:800; text-transform:uppercase;"></button>
        </div>
        
        <div class="card" style="padding:10px"><input type="text" id="p-input" oninput="checkPromo()" placeholder="–ü–†–û–ú–û–ö–û–î"></div>

        <div style="padding-bottom: 20px;">
            <div class="card" style="display:flex; justify-content:space-between; align-items:center">
                <div style="text-align:left"><b id="m1-name">Micro</b><br><small style="color:var(--neon)">+0.071/h</small></div>
                <button class="btn-buy" onclick="buy(3.90, 0.0714)">3.90 HK</button>
            </div>
            <div class="card" style="display:flex; justify-content:space-between; align-items:center">
                <div style="text-align:left"><b id="m2-name">Medium</b><br><small style="color:var(--neon)">+0.41/h</small></div>
                <button class="btn-buy" onclick="buy(19.49, 0.408)">19.49 HK</button>
            </div>
            <div class="card" style="display:flex; justify-content:space-between; align-items:center">
                <div style="text-align:left"><b id="m3-name">ULTRA</b><br><small style="color:var(--neon)">+5.10/h</small></div>
                <button class="btn-buy" onclick="buy(194.90, 5.10)">194.90 HK</button>
            </div>
        </div>
    </div>

    <div id="game-screen" class="screen">
        <div class="card">
            <h3 id="g-title">CRACK THE CODE</h3>
            <p id="g-desc" style="font-size:10px; opacity:0.6;">–ù–∞–π–¥–∏ –∫—Ä–∏—Å—Ç–∞–ª–ª üíé. –ö–∞—Ä—Ç–∞ –º–µ–Ω—è–µ—Ç—Å—è!</p>
            <div class="game-grid" id="game-grid">
                <div class="grid-cell" onclick="playGame(this)">?</div>
                <div class="grid-cell" onclick="playGame(this)">?</div>
                <div class="grid-cell" onclick="playGame(this)">?</div>
                <div class="grid-cell" onclick="playGame(this)">?</div>
                <div class="grid-cell" onclick="playGame(this)">?</div>
                <div class="grid-cell" onclick="playGame(this)">?</div>
                <div class="grid-cell" onclick="playGame(this)">?</div>
                <div class="grid-cell" onclick="playGame(this)">?</div>
                <div class="grid-cell" onclick="playGame(this)">?</div>
            </div>
            <div id="game-count" style="margin-top:20px; font-size:11px; color:var(--neon); font-weight:bold;">ATTEMPTS: 0 / 100</div>
        </div>
    </div>

    <div id="click-screen" class="screen">
        <div class="card" style="padding:10px; margin-bottom:10px; display:flex; justify-content:space-around; font-size:10px; font-weight:800;">
            <div>LVL: <span id="tap-lvl" style="color:var(--neon)">1</span></div>
            <div>TOTAL: <span id="tap-total" style="color:var(--neon)">0</span></div>
        </div>
        
        <div class="card" style="display:flex; justify-content:space-between; align-items:center; padding: 15px;">
            <div style="text-align:left">
                <b id="at-name">AUTOTAP</b><br>
                <small id="at-rate" style="color:var(--neon)">0.0 click/s</small>
            </div>
            <button id="at-btn" class="btn-buy" onclick="buyAutoTap()">68 HK</button>
        </div>

        <div class="tap-pill" onclick="tap()">
            <span id="target-txt" style="font-size:11px; opacity:0.5; margin-bottom:10px">...</span>
            <span style="font-size:48px; font-weight:900; color:var(--neon); letter-spacing:2px;">TAP</span>
            <div style="width:70%; height:8px; background:rgba(255,255,255,0.05); margin-top:25px; border-radius:10px; overflow:hidden; border:1px solid var(--border);">
                <div id="bar" style="width:0%; height:100%; background:var(--neon); box-shadow: 0 0 10px var(--neon);"></div>
            </div>
        </div>
    </div>

    <div id="top-screen" class="screen">
        <div class="card" style="flex:1; display:flex; flex-direction:column; padding:15px; text-align:left;">
            <h3 id="t-top-title" style="text-align:center;">–¢–û–ü –ò–ì–†–û–ö–û–í</h3>
            <button id="btn-find" class="find-me-btn" onclick="scrollToMe()">FIND ME üîç</button>
            <div id="leader-list" style="flex:1; overflow-y:auto;">...</div>
        </div>
    </div>

    <div class="nav">
        <button id="n-home" class="nav-item active" onclick="nav('home')">HOME</button>
        <button id="n-game" class="nav-item" onclick="nav('game')">GAMES</button>
        <button id="n-click" class="nav-item" onclick="nav('click')">MINING</button>
        <button id="n-top" class="nav-item" onclick="nav('top')">TOP</button>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js";
    import { getDatabase, ref, get, child, update } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-database.js";

    const firebaseConfig = { 
        apiKey: "AIzaSyBD-uKyTOd3iXNkisXyCkpgeXYzG4oySHM", 
        authDomain: "hkos-project.firebaseapp.com", 
        projectId: "hkos-project", 
        databaseURL: "https://hkos-project-default-rtdb.europe-west1.firebasedatabase.app" 
    };

    const fbApp = initializeApp(firebaseConfig);
    const db = getDatabase(fbApp);
    const tg = window.Telegram.WebApp;
    const userId = tg.initDataUnsafe?.user?.id || "dev_user";
    const startParam = tg.initDataUnsafe?.start_param;

    let hk = 0, hp = 0.017, myNick = '', isSaved = false, isDemo = false, usedPromos = [], curLang = 'ru';
    let boostUntil = 0, dailyGames = 0, lastResetDay = 0;
    let tapLvl = 1, tapTotal = 0, tapProgress = 0;
    let atR = 0, atP = 68;

    const lang = {
        ru: { 
            target: "–ü–†–û–ì–†–ï–°–° –¶–ò–ö–õ–ê", top: "–¢–û–ü –ò–ì–†–û–ö–û–í", buy: "–£–°–ü–ï–®–ù–û!", low: "–ú–ê–õ–û HK!", 
            ref: "–ü—Ä–∏–≥–ª–∞—Å–∏—Ç—å –¥—Ä—É–∑–µ–π", bonus: "–ó–ê–ë–†–ê–¢–¨ –ë–û–ù–£–°", off: "–û–§–§–õ–ê–ô–ù: +", promo: "–ü–†–û–ú–û–ö–û–î", 
            you: "(–í–´)", create: "–°–û–ó–î–ê–¢–¨ –ê–ö–ö–ê–£–ù–¢", demo: "–î–ï–ú–û-–†–ï–ñ–ò–ú", find: "–ù–ê–ô–¢–ò –ú–ï–ù–Ø üîç",
            gTitle: "–í–ó–õ–û–ú –ö–û–î–ê", gDesc: "–ù–∞–π–¥–∏ –∫—Ä–∏—Å—Ç–∞–ª–ª üíé. –ö–∞—Ä—Ç–∞ –º–µ–Ω—è–µ—Ç—Å—è!", 
            attempts: "–ü–û–ü–´–¢–ö–ò", lvlUp: "–ü–û–ü–û–õ–ù–ï–ù–ò–ï: +",
            refMsg: "–ë–û–ù–£–° –ü–†–ò–ù–Ø–¢: 10 HK + Micro-–º–∞–π–Ω–µ—Ä + –ë—É—Å—Ç x1.5 –Ω–∞ 24 —á–∞—Å–∞!",
            atName: "–ê–í–¢–û–¢–ê–ü 24/7"
        },
        ua: { 
            target: "–ü–†–û–ì–†–ï–° –¶–ò–ö–õ–£", top: "–¢–û–ü –ì–†–ê–í–¶–Ü–í", buy: "–£–°–ü–Ü–®–ù–û!", low: "–ú–ê–õ–û HK!", 
            ref: "–ó–∞–ø—Ä–æ—Å–∏—Ç–∏ –¥—Ä—É–∑—ñ–≤", bonus: "–ó–ê–ë–†–ê–¢–ò –ë–û–ù–£–°", off: "–û–§–õ–ê–ô–ù: +", promo: "–ü–†–û–ú–û–ö–û–î", 
            you: "(–í–ò)", create: "–°–¢–í–û–†–ò–¢–ò –ê–ö–ö–ê–£–ù–¢", demo: "–î–ï–ú–û-–†–ï–ñ–ò–ú", find: "–ó–ù–ê–ô–¢–ò –ú–ï–ù–ï üîç",
            gTitle: "–ó–õ–ê–ú –ö–û–î–£", gDesc: "–ó–Ω–∞–π–¥–∏ –∫—Ä–∏—Å—Ç–∞–ª üíé. –ö–∞—Ä—Ç–∞ –∑–º—ñ–Ω—é—î—Ç—å—Å—è!", 
            attempts: "–°–ü–†–û–ë–ò", lvlUp: "–ü–û–ü–û–í–ù–ï–ù–ù–Ø: +",
            refMsg: "–ë–û–ù–£–° –ü–†–ò–ô–ù–Ø–¢–û: 10 HK + Micro-–º–∞–π–Ω–µ—Ä + –ë—É—Å—Ç x1.5 –Ω–∞ 24 –≥–æ–¥–∏–Ω–∏!",
            atName: "–ê–í–¢–û–¢–ê–ü 24/7"
        },
        en: { 
            target: "CYCLE PROGRESS", top: "TOP PLAYERS", buy: "SUCCESS!", low: "NEED HK!", 
            ref: "Invite Friends", bonus: "GET BONUS", off: "OFFLINE: +", promo: "PROMOCODE", 
            you: "(YOU)", create: "CREATE ACCOUNT", demo: "DEMO MODE", find: "FIND ME üîç",
            gTitle: "CRACK THE CODE", gDesc: "Find üíé. Grid shuffles on miss!", 
            attempts: "ATTEMPTS", lvlUp: "DEPOSIT: +",
            refMsg: "REF BONUS: 10 HK + Micro miner + x1.5 Boost for 24h!",
            atName: "AUTOTAP 24/7"
        }
    };

    async function autoLogin() {
        tg.ready(); tg.expand();
        try {
            const s = await get(child(ref(db), `users/${userId}`));
            if(s.exists()){ 
                isSaved = true; 
                await load(); 
                document.getElementById('start-screen').style.display = 'none'; 
                document.getElementById('app').style.display = 'flex'; 
            } else { 
                document.getElementById('loader').style.display = 'none'; 
                document.getElementById('start-cont').style.display = 'block'; 
            }
        } catch (e) { 
            document.getElementById('loader').style.display = 'none'; 
            document.getElementById('start-cont').style.display = 'block'; 
        }
    }
    autoLogin();

    window.entry = (mode) => {
        if(mode === 'save') { isSaved = true; load(); } 
        else { isDemo = true; isSaved = false; myNick = "GUEST_" + Math.floor(Math.random()*999); runGame(); }
        document.getElementById('start-screen').style.display = 'none';
        document.getElementById('app').style.display = 'flex';
    };

    async function load() {
        try {
            const s = await get(child(ref(db), `users/${userId}`));
            const today = new Date().getUTCDate();
            if(s.exists()){
                const d = s.val();
                hk = d.hk || 0; hp = d.hp || 0.017; 
                tapLvl = d.tl || 1; tapTotal = d.tt || 0; tapProgress = d.tp || 0;
                atR = d.atR || 0; atP = d.atP || 68;
                boostUntil = d.bu || 0;
                lastResetDay = d.lrd || today;
                dailyGames = (lastResetDay !== today) ? 0 : (d.dg || 0);
                myNick = d.anon || "MINER_X";
                usedPromos = d.usedPromos || [];
                
                if(d.lv) {
                    let diffSec = (Date.now() - d.lv)/1000;
                    let mineSec = Math.min(diffSec, 10800);
                    let boost = (Date.now() < boostUntil) ? 1.5 : 1;
                    let mGain = ((hp * boost)/3600) * mineSec;
                    let totalAutoClicks = atR * diffSec;
                    let earnedFromTap = 0;
                    if(totalAutoClicks > 0) {
                        tapTotal += totalAutoClicks;
                        tapProgress += totalAutoClicks;
                        while(tapProgress >= 1000) { tapLvl++; tapProgress -= 1000; earnedFromTap += (0.05 + (tapLvl * 0.01)); }
                    }
                    let totalGain = mGain + earnedFromTap;
                    if(totalGain > 0.00001) { hk += totalGain; setTimeout(() => showNotif(lang[curLang].off + totalGain.toFixed(5), 5000), 1500); }
                }
            } else {
                myNick = "MINER_"+Math.random().toString(36).substring(7).toUpperCase();
                if(startParam) { hk = 10; hp = 0.09; boostUntil = Date.now() + 86400000; setTimeout(() => showNotif(lang[curLang].refMsg, 6000), 1000); }
            }
        } catch(e) {}
        runGame();
    }

    function runGame() {
        setInterval(() => { 
            let boost = (Date.now() < boostUntil) ? 1.5 : 1;
            hk += ((hp * boost)/3600)/10; 
            if(atR > 0) {
                let step = atR / 10;
                tapProgress += step; tapTotal += step;
                if(tapProgress >= 1000) { tapLvl++; tapProgress = 0; hk += (0.05 + (tapLvl * 0.01)); }
            }
            updateUI();
        }, 100);
        
        if(isSaved && !isDemo) {
            setInterval(() => {
                const today = new Date().getUTCDate();
                update(ref(db, `users/${userId}`), { hk, hp, tl: tapLvl, tt: tapTotal, tp: tapProgress, atR, atP, anon: myNick, usedPromos, lv: Date.now(), bu: boostUntil, dg: dailyGames, lrd: today });
            }, 8000);
        }
        setLang('ru');
    }

    window.buyAutoTap = () => {
        if(hk >= atP) { hk -= atP; atR += 0.3; atP = Math.floor(atP * 2.2); showNotif(lang[curLang].buy); updateUI(); } else showNotif(lang[curLang].low);
    };

    window.tap = () => {
        tapProgress++; tapTotal++;
        tg.HapticFeedback.impactOccurred('light');
        if(tapProgress >= 1000) {
            tapLvl++; tapProgress = 0;
            let prize = (0.05 + (tapLvl * 0.01));
            hk += prize;
            showNotif(lang[curLang].lvlUp + prize.toFixed(3), 4000);
            tg.HapticFeedback.notificationOccurred('success');
        }
        updateUI();
    };

    let isGameLocked = false;
    window.playGame = (cell) => {
        if(isGameLocked) return;
        if(dailyGames >= 100) { showNotif("LIMIT 100/DAY", 3000); return; }
        isGameLocked = true;
        const win = Math.random() < 0.11;
        dailyGames++;
        if(win) {
            let p = 0.005 + (hp * 0.01); hk += p;
            cell.innerText = "üíé"; cell.style.color = "#00ff88";
            showNotif("WIN: +" + p.toFixed(4), 4000);
            tg.HapticFeedback.notificationOccurred('success');
            setTimeout(resetGrid, 1500);
        } else {
            cell.innerText = "‚ùå"; cell.style.color = "#ff4444";
            tg.HapticFeedback.impactOccurred('medium');
            setTimeout(() => { document.getElementById('game-grid').classList.add('shuffling'); setTimeout(() => { resetGrid(); document.getElementById('game-grid').classList.remove('shuffling'); }, 400); }, 600);
        }
        updateUI();
    };

    function resetGrid() { document.querySelectorAll('.grid-cell').forEach(c => { c.innerText = "?"; c.style.color = "#fff"; }); isGameLocked = false; }

    window.setLang = (l) => {
        curLang = l;
        document.querySelectorAll('.lang-btn').forEach(b => b.classList.toggle('active', b.innerText.toLowerCase() === l));
        document.getElementById('btn-create').innerText = lang[l].create;
        document.getElementById('btn-demo').innerText = lang[l].demo;
        document.getElementById('ref-btn').innerText = lang[l].ref;
        document.getElementById('t-top-title').innerText = lang[l].top;
        document.getElementById('btn-find').innerText = lang[l].find;
        document.getElementById('g-title').innerText = lang[l].gTitle;
        document.getElementById('g-desc').innerText = lang[l].gDesc;
        document.getElementById('at-name').innerText = lang[l].atName;
        updateUI();
    };

    window.buy = (cost, prod) => { if(hk >= cost) { hk -= cost; hp += prod; showNotif(lang[curLang].buy); updateUI(); } else showNotif(lang[curLang].low); };

    window.checkPromo = () => {
        let v = document.getElementById('p-input').value.toUpperCase().trim();
        if(v === "/ADMINTAP") { atR += 0.3; showNotif("ADMIN: +0.3 cl/s"); document.getElementById('p-input').value = ""; updateUI(); return; }
        if(v === "/SBROSTAP") { atR = 0; showNotif("RESET AUTOCLICK"); document.getElementById('p-input').value = ""; updateUI(); return; }
        
        // –ù–û–í–´–ï –ö–û–ú–ê–ù–î–´ v40.0
        if(v === "/SBROSMINING") { hp = hp / 2; showNotif("MINING HALVED 50%"); document.getElementById('p-input').value = ""; updateUI(); return; }
        if(v.startsWith("/MINUS")) {
            let num = parseFloat(v.replace("/MINUS", ""));
            if(!isNaN(num)) { hk = Math.max(0, hk - num); showNotif("-" + num + " HK"); }
            document.getElementById('p-input').value = ""; updateUI(); return;
        }

        if(usedPromos.includes(v)) return;
        if(v === "XYRO") { hk += 5; usedPromos.push(v); showNotif("+5 HK!"); document.getElementById('p-input').value = ""; }
        if(v === "/NOTBAN") { hk += 10; usedPromos.push(v); showNotif("ADMIN MODE"); document.getElementById('p-input').value = ""; }
    };

    window.nav = (s) => {
        document.querySelectorAll('.screen').forEach(e => e.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(e => e.classList.remove('active'));
        document.getElementById(s + '-screen').classList.add('active');
        document.getElementById('n-' + s).classList.add('active');
        if(s === 'top') loadTop();
    };

    async function loadTop() {
        const list = document.getElementById('leader-list'); list.innerHTML = "...";
        try {
            const snap = await get(ref(db, 'users'));
            if(!snap.exists()) return;
            let p = []; snap.forEach(c => { const v = c.val(); p.push({ name: v.anon || "USER", hk: v.hk || 0, isMe: (c.key == userId) }); });
            p.sort((a,b) => b.hk - a.hk);
            list.innerHTML = p.slice(0, 50).map((u, i) => { const h = u.isMe && !isDemo ? 'me-highlight' : ''; const id = u.isMe ? 'id="me-row"' : ''; return `<div class="leader-row ${h}" ${id}><span>#${i+1} ${u.name}${u.isMe && !isDemo ? ' '+lang[curLang].you : ''}</span><b>${Number(u.hk).toFixed(2)}</b></div>`; }).join('');
        } catch(e) {}
    }

    window.scrollToMe = () => { const me = document.getElementById('me-row'); if(me) me.scrollIntoView({ behavior: 'smooth', block: 'center' }); else showNotif("NOT IN TOP 50"); };

    window.shareRef = () => { if(isSaved) tg.openTelegramLink(`https://t.me/share/url?url=https://t.me/Hakos_mining_bot/app?startapp=${userId}&text=–ú–∞–π–Ω–∏, —Ç–∞–ø–∞–π HK –∏ –∂–¥–∏ –ª–∏—Å—Ç–∏–Ω–≥! üíé`); };

    function updateUI() {
        document.getElementById('hk-num').innerText = hk.toFixed(6);
        document.getElementById('user-display').innerText = "ID: " + myNick;
        document.getElementById('tap-lvl').innerText = tapLvl;
        document.getElementById('tap-total').innerText = Math.floor(tapTotal);
        document.getElementById('target-txt').innerText = `${lang[curLang].target}: ${Math.floor(tapProgress)} / 1000`;
        document.getElementById('bar').style.width = (tapProgress/10) + "%";
        document.getElementById('game-count').innerText = `${lang[curLang].attempts}: ${dailyGames} / 100`;
        document.getElementById('at-rate').innerText = `${atR.toFixed(1)} click/s`;
        document.getElementById('at-btn').innerText = `${atP} HK`;
        const boost = (Date.now() < boostUntil) ? 1.5 : 1;
        document.getElementById('ps-num').innerHTML = `${((hp * boost)/3600).toFixed(5)} HK/s ${boost > 1 ? '<span class="boost-tag" style="display:inline">x1.5</span>' : ''}`;
    }

    function showNotif(txt, dur = 2000) { let n = document.getElementById('notif'); n.innerText = txt; n.classList.add('show'); setTimeout(() => n.classList.remove('show'), dur); }

    const cv = document.getElementById('matrix'), cx = cv.getContext('2d');
    cv.width = window.innerWidth; cv.height = window.innerHeight;
    const dr = Array(25).fill(1);
    const symbols = ["‚öí", "üíé", "‚öôÔ∏è", "HK", "0", "1"];
    setInterval(() => {
        cx.fillStyle = "rgba(0,0,0,0.15)"; cx.fillRect(0,0,cv.width,cv.height);
        cx.fillStyle = "rgba(0,255,136,0.12)";
        cx.font = "12px monospace";
        dr.forEach((y, i) => { 
            const s = symbols[Math.floor(Math.random()*symbols.length)];
            cx.fillText(s, i*20, y*15); if(y*15 > cv.height && Math.random() > 0.95) dr[i] = 0; dr[i]++; 
        });
    }, 120);
</script>
</body>
    </html>
