<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>HKos Pro v27.1</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root { --bg: #000; --neon: #00ff88; --glass: rgba(255, 255, 255, 0.08); --border: rgba(255, 255, 255, 0.1); }
        * { -webkit-tap-highlight-color: transparent; box-sizing: border-box; user-select: none; }
        body { margin: 0; background: var(--bg); color: #fff; font-family: -apple-system, sans-serif; overflow: hidden; height: 100vh; }
        
        canvas { position: fixed; top: 0; left: 0; z-index: 1; opacity: 0.1; pointer-events: none; }
        .app { position: relative; z-index: 10; display: flex; flex-direction: column; height: 100vh; padding: 10px 20px 110px; }

        .lang-bar { display: flex; justify-content: center; gap: 10px; margin-bottom: 10px; }
        .lang-btn { background: var(--glass); border: 1px solid var(--border); color: #fff; padding: 5px 10px; border-radius: 10px; font-size: 10px; cursor: pointer; }
        .lang-btn.active { border-color: var(--neon); color: var(--neon); }

        .ios-notif { 
            position: fixed; top: -100px; left: 50%; transform: translateX(-50%); 
            width: 85%; background: rgba(20,20,20,0.95); backdrop-filter: blur(20px); 
            border: 1px solid var(--border); border-radius: 20px; padding: 15px; 
            text-align: center; z-index: 10000; transition: 0.4s;
        }
        .ios-notif.show { top: 25px; }

        .card { 
            background: var(--glass); backdrop-filter: blur(25px); -webkit-backdrop-filter: blur(25px);
            border-radius: 25px; border: 1px solid var(--border); 
            padding: 20px; text-align: center; margin-bottom: 12px;
        }

        .user-nick { font-size: 10px; color: var(--neon); font-weight: 800; letter-spacing: 1px; margin-bottom: 5px; opacity: 0.8; }
        .hk-val { font-size: 34px; font-weight: 800; font-variant-numeric: tabular-nums; text-shadow: 0 0 15px rgba(0, 255, 136, 0.3); }
        
        .btn-buy { background: var(--neon); color: #000; border: none; padding: 12px 18px; border-radius: 15px; font-weight: 900; font-size: 12px; cursor: pointer; }

        .tap-pill { width: 100%; height: 120px; background: var(--glass); border-radius: 35px; border: 1px solid var(--border); display: flex; flex-direction: column; align-items: center; justify-content: center; }

        .nav { position: fixed; bottom: 30px; left: 20px; right: 20px; display: flex; justify-content: space-around; background: rgba(10,10,10,0.9); backdrop-filter: blur(20px); padding: 18px; border-radius: 30px; border: 1px solid var(--border); z-index: 5000; }
        .nav-item { color: rgba(255,255,255,0.3); border: none; background: none; font-size: 11px; font-weight: bold; }
        .nav-item.active { color: var(--neon); }

        .screen { display: none; flex-direction: column; height: 100%; overflow: hidden; }
        .screen.active { display: flex; }
        
        input { background: rgba(255,255,255,0.05); border: 1px solid var(--border); color: #fff; text-align: center; width: 100%; padding: 12px; border-radius: 15px; outline: none; }
        
        .leader-row { display: flex; justify-content: space-between; padding: 15px; border-bottom: 1px solid rgba(255,255,255,0.05); border-radius: 15px; margin: 4px 0; }
        .leader-row.me { background: rgba(0, 255, 136, 0.2); border: 1px solid var(--neon); }
        
        #find-me-btn { display: none; background: var(--neon); color: #000; border: none; padding: 12px; border-radius: 14px; font-weight: 800; font-size: 10px; margin-top: 10px; width: 100%; }
    </style>
</head>
<body>

<div id="notif" class="ios-notif">ðŸ’Ž</div>
<canvas id="matrix"></canvas>

<div class="app">
    <div class="lang-bar">
        <div class="lang-btn active" onclick="setLang('ru')">RU</div>
        <div class="lang-btn" onclick="setLang('ua')">UA</div>
        <div class="lang-btn" onclick="setLang('en')">EN</div>
    </div>

    <div id="home-screen" class="screen active">
        <div class="card">
            <div id="user-display" class="user-nick">...</div>
            <div id="hk-num" class="hk-val">0.00000000</div>
            <div id="ps-num" style="color:var(--neon); font-size:12px; font-weight:700">0.00000 HK/s</div>
        </div>
        <div class="card" style="padding:10px"><input type="text" id="p-input" oninput="checkPromo()" placeholder="..."></div>
        <div style="overflow-y:auto; flex:1">
            <div class="card" style="display:flex; justify-content:space-between; align-items:center">
                <div style="text-align:left"><b>Micro</b><br><small style="color:var(--neon)">+0.07/h</small></div>
                <button class="btn-buy" onclick="buy(3, 0.07)">3 HK</button>
            </div>
            <div class="card" style="display:flex; justify-content:space-between; align-items:center">
                <div style="text-align:left"><b>Medium</b><br><small style="color:var(--neon)">+0.40/h</small></div>
                <button class="btn-buy" onclick="buy(15, 0.40)">15 HK</button>
            </div>
            <div class="card" style="display:flex; justify-content:space-between; align-items:center">
                <div style="text-align:left"><b>ULTRA</b><br><small style="color:var(--neon)">+5.00/h</small></div>
                <button class="btn-buy" onclick="buy(150, 5.0)">150 HK</button>
            </div>
        </div>
    </div>

    <div id="click-screen" class="screen">
        <div class="tap-pill" onclick="tap()" style="margin: auto 0;">
            <span id="target-txt" style="font-size:11px; opacity:0.5; margin-bottom:10px">...</span>
            <span style="font-size:42px; font-weight:900; color:var(--neon)">TAP</span>
            <div style="width:60%; height:6px; background:rgba(255,255,255,0.1); margin-top:20px; border-radius:10px; overflow:hidden">
                <div id="bar" style="width:0%; height:100%; background:var(--neon)"></div>
            </div>
        </div>
    </div>

    <div id="top-screen" class="screen">
        <div class="card" style="flex:1; display: flex; flex-direction: column; overflow: hidden;">
            <h3 class="t-top-title" style="margin-top:0">TOP PLAYERS</h3>
            <div id="leader-list" style="flex:1; overflow-y:auto; text-align: left;">...</div>
            <button id="find-me-btn" onclick="scrollToMe()" class="t-find-me">Ð“Ð”Ð• Ð¯?</button>
        </div>
    </div>

    <div class="nav">
        <button id="n-home" class="nav-item active" onclick="nav('home')">HOME</button>
        <button id="n-click" class="nav-item" onclick="nav('click')">TAP</button>
        <button id="n-top" class="nav-item" onclick="nav('top')">TOP</button>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js";
    import { getDatabase, ref, get, child, update, remove } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBD-uKyTOd3iXNkisXyCkpgeXYzG4oySHM",
        authDomain: "hkos-project.firebaseapp.com",
        projectId: "hkos-project",
        databaseURL: "https://hkos-project-default-rtdb.europe-west1.firebasedatabase.app"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const tg = window.Telegram.WebApp;
    const userId = tg.initDataUnsafe?.user?.id || "user_v27_stable";
    const myNick = "ID_" + String(userId).slice(0, 8);

    let hk = 0, hp = 0.02, si = 0, cc = 0, usedPromos = [], displayHk = 0, curLang = 'ru';

    const langData = {
        ru: { nick: "ÐÐ˜Ðš", promo: "ÐŸÐ ÐžÐœÐžÐšÐžÐ”", target: "Ð¦Ð•Ð›Ð¬", findme: "Ð“Ð”Ð• Ð¯?", top: "Ð¢ÐžÐŸ Ð˜Ð“Ð ÐžÐšÐžÐ’", buy: "ÐšÑƒÐ¿Ð»ÐµÐ½Ð¾!", low: "ÐœÐ°Ð»Ð¾ HK!", offline: "ÐžÑ„Ñ„Ð»Ð°Ð¹Ð½ Ð´Ð¾Ñ…Ð¾Ð´: ", deleted: "ÐÐºÐºÐ°ÑƒÐ½Ñ‚ ÑƒÐ´Ð°Ð»ÐµÐ½ Ð·Ð° Ð½ÐµÐ°ÐºÑ‚Ð¸Ð²Ð½Ð¾ÑÑ‚ÑŒ (1 Ð¼ÐµÑ)" },
        ua: { nick: "ÐÐ†Ðš", promo: "ÐŸÐ ÐžÐœÐžÐšÐžÐ”", target: "Ð¦Ð†Ð›Ð¬", findme: "Ð”Ð• Ð¯?", top: "Ð¢ÐžÐŸ Ð“Ð ÐÐ’Ð¦Ð†Ð’", buy: "ÐšÑƒÐ¿Ð»ÐµÐ½Ð¾!", low: "ÐœÐ°Ð»Ð¾ HK!", offline: "ÐžÑ„Ñ„Ð»Ð°Ð¹Ð½ Ð´Ð¾Ñ…Ñ–Ð´: ", deleted: "ÐÐºÐºÐ°ÑƒÐ½Ñ‚ Ð²Ð¸Ð´Ð°Ð»ÐµÐ½Ð¾ Ð·Ð° Ð½ÐµÐ°ÐºÑ‚Ð¸Ð²Ð½Ñ–ÑÑ‚ÑŒ (1 Ð¼Ñ–Ñ)" },
        en: { nick: "NICK", promo: "PROMOCODE", target: "TARGET", findme: "FIND ME", top: "TOP PLAYERS", buy: "Bought!", low: "Need HK!", offline: "Offline income: ", deleted: "Account deleted due to inactivity (1 mo)" }
    };

    window.setLang = (l) => {
        curLang = l;
        document.querySelectorAll('.lang-btn').forEach(b => b.classList.remove('active'));
        if(event) event.target.classList.add('active');
        document.getElementById('p-input').placeholder = langData[l].promo;
        document.querySelector('.t-top-title').innerText = langData[l].top;
        document.querySelector('.t-find-me').innerText = langData[l].findme;
        updateUI();
    };

    async function load() {
        const s = await get(child(ref(db), `users/${userId}`));
        if(s.exists()){
            const d = s.val();
            let now = Date.now();
            
            // ÐŸÐ ÐžÐ’Ð•Ð ÐšÐ ÐÐ Ð£Ð”ÐÐ›Ð•ÐÐ˜Ð• (1 ÐœÐ•Ð¡Ð¯Ð¦ ÐÐ•ÐÐšÐ¢Ð˜Ð’Ð)
            if(d.lv && (now - d.lv) > (30 * 24 * 3600 * 1000)) {
                await remove(ref(db, `users/${userId}`));
                showNotif(langData[curLang].deleted);
                // Ð¡Ð±Ñ€Ð¾Ñ Ð»Ð¾ÐºÐ°Ð»ÑŒÐ½Ñ‹Ñ… Ð´Ð°Ð½Ð½Ñ‹Ñ…
                hk = 0; hp = 0.02; si = 0; cc = 0; usedPromos = [];
            } else {
                hk = Number(d.hk) || 0; hp = Number(d.hp) || 0.02;
                si = d.si || 0; cc = d.cc || 0;
                usedPromos = d.usedPromos || [];
                
                // ÐžÐ¤Ð¤Ð›ÐÐ™Ð Ð”ÐžÐ¥ÐžÐ” (3 Ñ‡Ð°ÑÐ°)
                if(d.lv) {
                    let diff = (now - d.lv) / 1000;
                    let earnedSec = Math.min(diff, 3 * 3600);
                    let income = (hp / 3600) * earnedSec;
                    if(income > 0.0001) {
                        hk += income;
                        showNotif(langData[curLang].offline + "+" + income.toFixed(4));
                    }
                }
            }
            displayHk = hk;
        }
        setInterval(() => {
            hk += (hp / 3600) / 30;
            displayHk += (hk - displayHk) * 0.12;
            document.getElementById('hk-num').innerText = displayHk.toFixed(8);
            document.getElementById('ps-num').innerText = (hp/3600).toFixed(5) + " HK/s";
        }, 33);
        setInterval(save, 8000);
        setLang('ru');
    }

    window.tap = () => {
        cc++;
        let target = 10 + (si * 15);
        tg.HapticFeedback.impactOccurred('medium');
        if(cc >= target) {
            let r = 0.01 + (si * 0.005);
            hk += r; cc = 0; si++;
            showNotif("+" + r.toFixed(4) + " HK");
        }
        updateUI();
    };

    window.buy = (cost, prod) => {
        if(hk >= cost) {
            hk -= cost; hp += prod;
            showNotif(langData[curLang].buy);
            updateUI(); save();
        } else showNotif(langData[curLang].low);
    };

    window.checkPromo = () => {
        let v = document.getElementById('p-input').value.trim().toUpperCase();
        if(usedPromos.includes(v)) return;
        let ok = false;
        if(v === "HK") { hk += 1; ok = true; }
        else if(v === "MAIN") { hp += 0.07; ok = true; }
        else if(v === "ADMIN") { hk += 5; ok = true; } 
        if(ok) {
            usedPromos.push(v);
            document.getElementById('p-input').value = "";
            showNotif("OK!");
            save();
        }
    };

    window.nav = (s) => {
        document.querySelectorAll('.screen').forEach(e => e.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(e => e.classList.remove('active'));
        document.getElementById(s + '-screen').classList.add('active');
        document.getElementById('n-' + s).classList.add('active');
        if(s === 'top') loadTop();
    };

    async function loadTop() {
        const list = document.getElementById('leader-list');
        list.innerHTML = "...";
        try {
            const snapshot = await get(ref(db, 'users'));
            if(!snapshot.exists()) return;
            let players = [];
            snapshot.forEach(c => {
                let v = c.val();
                players.push({ id: c.key, name: v.anon || 'Anon', hk: v.hk || 0 });
            });
            players.sort((a,b) => b.hk - a.hk);
            list.innerHTML = "";
            players.forEach((p, i) => {
                let isMe = p.id == userId;
                list.innerHTML += `<div class="leader-row ${isMe?'me':''}" id="${isMe?'me-row':''}">
                    <span>#${i+1} ${p.name}</span>
                    <b>${Number(p.hk).toFixed(2)}</b>
                </div>`;
            });
            document.getElementById('find-me-btn').style.display = 'block';
        } catch(e) { list.innerHTML = "Err"; }
    }

    window.scrollToMe = () => {
        const me = document.getElementById('me-row');
        if(me) me.scrollIntoView({ behavior: 'smooth', block: 'center' });
    };

    function updateUI() {
        let target = 10 + (si * 15);
        document.getElementById('user-display').innerText = langData[curLang].nick + ": " + myNick;
        document.getElementById('target-txt').innerText = langData[curLang].target + `: ${cc} / ${target}`;
        document.getElementById('bar').style.width = (cc/target*100) + "%";
    }

    function showNotif(txt) {
        const n = document.getElementById('notif');
        n.innerText = txt; n.classList.add('show');
        setTimeout(() => n.classList.remove('show'), 3000);
    }

    function save() {
        update(ref(db, `users/${userId}`), {
            hk: hk, hp: hp, si: si, cc: cc, usedPromos: usedPromos, anon: myNick, lv: Date.now()
        });
    }

    load();
    const cv = document.getElementById('matrix'), cx = cv.getContext('2d');
    cv.width = window.innerWidth; cv.height = window.innerHeight;
    const dr = Array(20).fill(1);
    setInterval(() => {
        cx.fillStyle = "rgba(0,0,0,0.15)"; cx.fillRect(0,0,cv.width,cv.height);
        cx.fillStyle = "rgba(0,255,136,0.1)";
        dr.forEach((y, i) => {
            cx.fillText("HK", i*25, y*15);
            if(y*15 > cv.height && Math.random() > 0.95) dr[i] = 0;
            dr[i]++;
        });
    }, 120);
</script>
</body>
    </html>
