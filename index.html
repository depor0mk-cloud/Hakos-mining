<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Hakos Mining v30.8</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root { --bg: #000; --neon: #00ff88; --glass: rgba(255, 255, 255, 0.07); --border: rgba(255, 255, 255, 0.1); }
        * { -webkit-tap-highlight-color: transparent; box-sizing: border-box; user-select: none; outline: none; transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); }
        body { margin: 0; background: var(--bg); color: #fff; font-family: -apple-system, sans-serif; overflow: hidden; height: 100vh; }
        
        canvas { position: fixed; inset: 0; z-index: 1; opacity: 0.12; pointer-events: none; }
        .version { position: fixed; bottom: 8px; right: 12px; font-size: 8px; color: rgba(255,255,255,0.1); z-index: 10001; }
        
        #start-screen { position: fixed; inset: 0; background: #000; z-index: 10000; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 30px; }
        .app { position: relative; z-index: 10; display: none; flex-direction: column; height: 100vh; padding: 10px 20px 110px; animation: fadeIn 0.6s ease; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .loader { width: 30px; height: 30px; border: 2px solid var(--glass); border-top-color: var(--neon); border-radius: 50%; animation: spin 0.8s linear infinite; margin-top: 20px; }
        @keyframes spin { to { transform: rotate(360deg); } }

        .lang-capsule { display: flex; align-self: center; background: var(--glass); border: 1px solid var(--border); border-radius: 20px; padding: 3px; margin-bottom: 15px; }
        .lang-btn { background: none; border: none; color: #555; padding: 4px 10px; border-radius: 15px; font-size: 9px; font-weight: 800; cursor: pointer; }
        .lang-btn.active { background: var(--neon); color: #000; }

        .card { background: var(--glass); backdrop-filter: blur(25px); border-radius: 25px; border: 1px solid var(--border); padding: 20px; text-align: center; margin-bottom: 12px; }
        .hk-val { font-size: 34px; font-weight: 800; text-shadow: 0 0 15px rgba(0, 255, 136, 0.3); letter-spacing: -1px; }
        
        .btn-buy { background: var(--neon); color: #000; border: none; padding: 12px 18px; border-radius: 15px; font-weight: 900; font-size: 11px; cursor: pointer; }
        .btn-buy:active { transform: scale(0.94); }
        
        .tap-pill { width: 100%; height: 140px; background: var(--glass); border-radius: 40px; border: 1px solid var(--border); display: flex; flex-direction: column; align-items: center; justify-content: center; margin: auto 0; }
        .tap-pill:active { transform: scale(0.97); }

        .nav { position: fixed; bottom: 30px; left: 20px; right: 20px; display: flex; justify-content: space-around; background: rgba(10,10,10,0.8); backdrop-filter: blur(20px); padding: 18px; border-radius: 30px; border: 1px solid var(--border); z-index: 5000; }
        .nav-item { color: rgba(255,255,255,0.3); border: none; background: none; font-size: 11px; font-weight: bold; }
        .nav-item.active { color: var(--neon); }

        .screen { display: none; flex-direction: column; height: 100%; overflow-y: auto; }
        .screen.active { display: flex; }
        
        .leader-row { display: flex; justify-content: space-between; padding: 12px 5px; border-bottom: 1px solid rgba(255,255,255,0.05); font-size: 14px; }
        .leader-row b { color: var(--neon); }

        .ios-notif { position: fixed; top: -100px; left: 50%; transform: translateX(-50%); width: 85%; background: rgba(20,20,20,0.95); border-radius: 20px; padding: 15px; text-align: center; z-index: 10000; transition: 0.5s; color: var(--neon); font-weight: bold; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .ios-notif.show { top: 25px; }

        input { background: none; border: none; color: #fff; text-align: center; width: 100%; font-size: 12px; letter-spacing: 2px; }
    </style>
</head>
<body>

<div class="version">v30.8 CLEAN_TOP</div>
<div id="notif" class="ios-notif"></div>
<canvas id="matrix"></canvas>

<div id="start-screen">
    <div style="font-size: 40px; font-weight: 900; color: var(--neon); letter-spacing: 5px;">HAKOS</div>
    <div id="loader" class="loader"></div>
    <div id="start-cont" style="width: 100%; display: none; margin-top: 30px;">
        <button onclick="entry(true)" style="background:var(--neon); color:#000; border:none; padding:18px; border-radius:20px; font-weight:900; width:100%; margin-bottom:12px;">–°–û–ó–î–ê–¢–¨ –ê–ö–ö–ê–£–ù–¢</button>
        <button onclick="entry(false)" style="background:transparent; color:#555; border:1px solid #333; padding:12px; border-radius:15px; width:100%; font-size:11px;">–ë–ï–ó –°–û–•–†–ê–ù–ï–ù–ò–Ø</button>
    </div>
</div>

<div class="app" id="app">
    <div class="lang-capsule">
        <button class="lang-btn active" onclick="setLang('ru')">RU</button>
        <button class="lang-btn" onclick="setLang('ua')">UA</button>
        <button class="lang-btn" onclick="setLang('en')">EN</button>
    </div>

    <div id="home-screen" class="screen active">
        <div class="card">
            <div id="user-display" style="font-size:10px; color:var(--neon); font-weight:800; letter-spacing:2px; margin-bottom:5px; opacity:0.6">ID: ...</div>
            <div id="hk-num" class="hk-val">0.000000</div>
            <div id="ps-num" style="color:var(--neon); font-size:12px; font-weight:700; margin-top:5px;">0.00000 HK/s</div>
            <button onclick="shareRef()" id="ref-btn" style="background:rgba(255,255,255,0.03); color:#fff; border:1px solid var(--border); width:100%; padding:12px; border-radius:15px; font-size:10px; margin-top:15px; font-weight:800;"></button>
        </div>
        
        <div class="card" style="padding:10px"><input type="text" id="p-input" oninput="checkPromo()" placeholder="–ü–†–û–ú–û–ö–û–î"></div>

        <div style="padding-bottom: 20px;">
            <div class="card" style="display:flex; justify-content:space-between; align-items:center">
                <div style="text-align:left"><b>Micro</b><br><small style="color:var(--neon)">+0.084/h</small></div>
                <button class="btn-buy" onclick="buy(3.39, 0.084)">3.39 HK</button>
            </div>
            <div class="card" style="display:flex; justify-content:space-between; align-items:center">
                <div style="text-align:left"><b>Medium</b><br><small style="color:var(--neon)">+0.48/h</small></div>
                <button class="btn-buy" onclick="buy(16.95, 0.48)">16.95 HK</button>
            </div>
            <div class="card" style="display:flex; justify-content:space-between; align-items:center">
                <div style="text-align:left"><b>ULTRA</b><br><small style="color:var(--neon)">+6.00/h</small></div>
                <button class="btn-buy" onclick="buy(169.50, 6.00)">169.50 HK</button>
            </div>
        </div>
    </div>

    <div id="click-screen" class="screen">
        <div class="tap-pill" onclick="tap()">
            <span id="target-txt" style="font-size:11px; opacity:0.5; margin-bottom:10px">...</span>
            <span style="font-size:42px; font-weight:900; color:var(--neon)">TAP</span>
            <div style="width:60%; height:6px; background:rgba(255,255,255,0.1); margin-top:20px; border-radius:10px; overflow:hidden">
                <div id="bar" style="width:0%; height:100%; background:var(--neon);"></div>
            </div>
        </div>
    </div>

    <div id="top-screen" class="screen">
        <div class="card" style="flex:1; display:flex; flex-direction:column; padding:15px; text-align:left;">
            <h3 id="t-top-title" style="margin:0 0 15px 0; text-align:center;">–¢–û–ü –ò–ì–†–û–ö–û–í</h3>
            <div id="leader-list" style="flex:1; overflow-y:auto;">...</div>
        </div>
    </div>

    <div class="nav">
        <button id="n-home" class="nav-item active" onclick="nav('home')">HOME</button>
        <button id="n-click" class="nav-item" onclick="nav('click')">MINING</button>
        <button id="n-top" class="nav-item" onclick="nav('top')">TOP</button>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js";
    import { getDatabase, ref, get, child, update } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-database.js";

    const firebaseConfig = { apiKey: "AIzaSyBD-uKyTOd3iXNkisXyCkpgeXYzG4oySHM", authDomain: "hkos-project.firebaseapp.com", projectId: "hkos-project", databaseURL: "https://hkos-project-default-rtdb.europe-west1.firebasedatabase.app" };
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const tg = window.Telegram.WebApp;
    const userId = tg.initDataUnsafe?.user?.id || "dev_user";
    const startParam = tg.initDataUnsafe?.start_param;

    let hk = 0, hp = 0.02, si = 0, cc = 0, myNick = '', isSaved = false, usedPromos = [], curLang = 'ru';

    const lang = {
        ru: { target: "–¶–ï–õ–¨", top: "–¢–û–ü –ò–ì–†–û–ö–û–í", buy: "–£–°–ü–ï–®–ù–û!", low: "–ú–ê–õ–û HK!", ref: "–ü–†–ò–ì–õ–ê–°–ò–¢–¨ –î–†–£–ó–ï–ô", bonus: "–ó–ê–ë–†–ê–¢–¨ –ë–û–ù–£–°", off: "–û–§–§–õ–ê–ô–ù: +", promo: "–ü–†–û–ú–û–ö–û–î" },
        ua: { target: "–¶–Ü–õ–¨", top: "–¢–û–ü –ì–†–ê–í–¶–Ü–í", buy: "–£–°–ü–Ü–®–ù–û!", low: "–ú–ê–õ–û HK!", ref: "–ó–ê–ü–†–û–°–ò–¢–ò –î–†–£–ó–Ü–í", bonus: "–ó–ê–ë–†–ê–¢–ò –ë–û–ù–£–°", off: "–û–§–õ–ê–ô–ù: +", promo: "–ü–†–û–ú–û–ö–û–î" },
        en: { target: "TARGET", top: "TOP PLAYERS", buy: "SUCCESS!", low: "NEED HK!", ref: "INVITE FRIENDS", bonus: "GET BONUS", off: "OFFLINE: +", promo: "PROMOCODE" }
    };

    function generateLetterNick() {
        const abc = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
        let res = "";
        for (let i = 0; i < 6; i++) res += abc.charAt(Math.floor(Math.random() * abc.length));
        return "USER_" + res;
    }

    async function autoLogin() {
        const s = await get(child(ref(db), `users/${userId}`));
        if(s.exists()){
            isSaved = true;
            await load();
            document.getElementById('start-screen').style.display = 'none';
            document.getElementById('app').style.display = 'flex';
        } else {
            document.getElementById('loader').style.display = 'none';
            document.getElementById('start-cont').style.display = 'block';
        }
    }
    autoLogin();

    window.entry = (save) => {
        isSaved = save;
        if(save) load(); else { myNick = "GUEST"; runGame(); }
        document.getElementById('start-screen').style.display = 'none';
        document.getElementById('app').style.display = 'flex';
    };

    async function load() {
        const s = await get(child(ref(db), `users/${userId}`));
        if(s.exists()){
            const d = s.val();
            hk = d.hk || 0; hp = d.hp || 0.02; si = d.si || 0; cc = d.cc || 0;
            // –ï—Å–ª–∏ –Ω–∏–∫ —á–∏—Å–ª–æ–≤–æ–π –∏–ª–∏ –ø—É—Å—Ç–æ–π - –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º –Ω–æ–≤—ã–π –±—É–∫–≤–µ–Ω–Ω—ã–π
            myNick = (d.anon && isNaN(d.anon)) ? d.anon : generateLetterNick();
            usedPromos = d.usedPromos || [];
            if(d.lv) {
                let offSec = Math.min((Date.now() - d.lv)/1000, 10800);
                let gain = (hp/3600)*offSec;
                if(gain > 0.0001) { hk += gain; showNotif(lang[curLang].off + gain.toFixed(4)); }
            }
        } else {
            myNick = generateLetterNick();
            if(startParam) { hk = 3; hp = 0.104; }
        }
        runGame();
    }

    function runGame() {
        setInterval(() => { hk += (hp/3600)/10; document.getElementById('hk-num').innerText = hk.toFixed(6); }, 100);
        if(isSaved) setInterval(() => update(ref(db, `users/${userId}`), { hk, hp, si, cc, anon: myNick, usedPromos, lv: Date.now() }), 8000);
        setLang('ru');
    }

    window.setLang = (l) => {
        curLang = l;
        document.querySelectorAll('.lang-btn').forEach(b => b.classList.toggle('active', b.innerText.toLowerCase() === l));
        document.getElementById('t-top-title').innerText = lang[l].top;
        document.getElementById('p-input').placeholder = lang[l].promo;
        const isNew = (hk <= 3.1 && hp <= 0.11);
        document.getElementById('ref-btn').innerText = isNew ? lang[l].bonus : lang[l].ref;
        updateUI();
    };

    window.checkPromo = () => {
        let v = document.getElementById('p-input').value.toUpperCase().trim();
        if(usedPromos.includes(v)) return;
        if(v === "XYRO") { hk += 5; usedPromos.push(v); showNotif("+5 HK!"); document.getElementById('p-input').value = ""; }
        if(v === "/NOTBAN") { hk += 1000; usedPromos.push(v); showNotif("ADMIN PANEL"); document.getElementById('p-input').value = ""; }
    };

    window.tap = () => {
        cc++; let t = 10 + (si * 15); tg.HapticFeedback.impactOccurred('light');
        if(cc >= t) { let g = 0.01 + (si * 0.005); hk += g; cc = 0; si++; showNotif("+" + g.toFixed(3) + " HK"); }
        updateUI();
    };

    window.buy = (cost, prod) => {
        if(hk >= cost) { hk -= cost; hp += prod; showNotif(lang[curLang].buy); updateUI(); } else showNotif(lang[curLang].low);
    };

    window.nav = (s) => {
        document.querySelectorAll('.screen').forEach(e => e.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(e => e.classList.remove('active'));
        document.getElementById(s + '-screen').classList.add('active');
        document.getElementById('n-' + s).classList.add('active');
        if(s === 'top') loadTop();
    };

    async function loadTop() {
        const list = document.getElementById('leader-list'); list.innerHTML = "...";
        try {
            const snap = await get(ref(db, 'users'));
            if(!snap.exists()) return;
            let p = [];
            snap.forEach(c => {
                const v = c.val();
                let name = v.anon;
                // –ï—Å–ª–∏ –∏–º—è —Ü–∏—Ñ—Ä–æ–≤–æ–µ (ID) - –∑–∞–º–µ–Ω—è–µ–º –Ω–∞ MINER_XXXX
                if (!name || !isNaN(name)) name = "MINER_" + c.key.substring(0, 4).toUpperCase();
                p.push({ name: name, hk: v.hk || 0 });
            });
            p.sort((a,b) => b.hk - a.hk);
            list.innerHTML = p.slice(0, 50).map((u, i) => `<div class="leader-row"><span>#${i+1} ${u.name}</span><b>${Number(u.hk).toFixed(2)}</b></div>`).join('');
        } catch(e) { console.error(e); }
    }

    window.shareRef = () => { if(isSaved) tg.openTelegramLink(`https://t.me/share/url?url=https://t.me/Hakos_mining_bot/app?startapp=${userId}&text=–ú–∞–π–Ω–∏ HK! üíé`); };

    function updateUI() {
        let t = 10 + (si * 15);
        document.getElementById('user-display').innerText = "ID: " + myNick;
        document.getElementById('target-txt').innerText = `${lang[curLang].target}: ${cc} / ${t}`;
        document.getElementById('bar').style.width = (cc/t*100) + "%";
        document.getElementById('ps-num').innerText = (hp/3600).toFixed(5) + " HK/s";
    }

    function showNotif(txt) { let n = document.getElementById('notif'); n.innerText = txt; n.classList.add('show'); setTimeout(() => n.classList.remove('show'), 2000); }

    const cv = document.getElementById('matrix'), cx = cv.getContext('2d');
    cv.width = window.innerWidth; cv.height = window.innerHeight;
    const dr = Array(25).fill(1);
    setInterval(() => {
        cx.fillStyle = "rgba(0,0,0,0.15)"; cx.fillRect(0,0,cv.width,cv.height);
        cx.fillStyle = "rgba(0,255,136,0.1)";
        dr.forEach((y, i) => { cx.fillText("HK", i*20, y*15); if(y*15 > cv.height && Math.random() > 0.95) dr[i] = 0; dr[i]++; });
    }, 120);
</script>
</body>
</html>
