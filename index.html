<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>HKos iOS 26 Fixed</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root { --bg: #000; --neon: #00ff88; --glass: rgba(255,255,255,0.06); --ios-blur: blur(30px); }
        * { -webkit-tap-highlight-color: transparent; box-sizing: border-box; user-select: none; }
        body { margin: 0; background: var(--bg); color: #fff; font-family: -apple-system, sans-serif; overflow: hidden; height: 100vh; }
        
        canvas { position: fixed; top: 0; left: 0; z-index: -1; opacity: 0.15; }
        .app { display: flex; flex-direction: column; height: 100vh; padding: 20px 20px 100px; }

        .ios-notif { position: fixed; top: -100px; left: 50%; transform: translateX(-50%); width: 85%; background: rgba(20,20,20,0.95); backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,0.1); border-radius: 25px; padding: 18px; text-align: center; transition: 0.5s cubic-bezier(0.2, 1, 0.2, 1); z-index: 10000; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .ios-notif.show { top: 20px; }

        .card { background: var(--glass); backdrop-filter: var(--ios-blur); border-radius: 30px; border: 1px solid rgba(255,255,255,0.1); padding: 25px; text-align: center; margin-bottom: 12px; }
        .hk-val { font-size: 44px; font-weight: 800; letter-spacing: -1px; font-variant-numeric: tabular-nums; }
        
        .btn-buy { background: var(--neon); color: #000; border: none; padding: 12px 20px; border-radius: 18px; font-weight: 900; font-size: 13px; }
        .btn-buy:active { transform: scale(0.9); }

        .tap-pill { width: 100%; height: 140px; background: var(--glass); border-radius: 40px; border: 1px solid rgba(255,255,255,0.1); display: flex; flex-direction: column; align-items: center; justify-content: center; margin: auto 0; transition: 0.2s; }
        .tap-pill:active { background: rgba(0,255,136,0.1); transform: scale(0.96); }

        .nav { position: fixed; bottom: 30px; left: 20px; right: 20px; display: flex; justify-content: space-around; background: rgba(15,15,15,0.8); backdrop-filter: blur(20px); padding: 18px; border-radius: 30px; border: 1px solid rgba(255,255,255,0.1); }
        .nav-item { color: rgba(255,255,255,0.3); border: none; background: none; font-size: 11px; font-weight: 700; text-transform: uppercase; }
        .nav-item.active { color: var(--neon); }

        .screen { display: none; flex-direction: column; height: 100%; }
        .screen.active { display: flex; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        .lang-btn { position: absolute; top: 20px; left: 20px; background: var(--glass); color: #fff; border: 1px solid rgba(255,255,255,0.1); padding: 8px 15px; border-radius: 15px; font-size: 11px; font-weight: bold; z-index: 100; backdrop-filter: blur(10px); }
        input { background: transparent; border: none; color: #fff; text-align: center; width: 100%; outline: none; font-size: 14px; }
        .leader-row { display: flex; justify-content: space-between; padding: 14px; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .temp-badge { color: #ff3b30; font-size: 10px; font-weight: bold; margin-top: 5px; }
    </style>
</head>
<body>

<div id="notif" class="ios-notif">Успешно!</div>
<canvas id="matrix"></canvas>
<button class="lang-btn" onclick="toggleLang()" id="lang-ind">RU</button>

<div class="app">
    <div id="home-screen" class="screen active">
        <div class="card" style="margin-top:40px">
            <div id="hk-num" class="hk-val">0.0000</div>
            <div id="ps-num" style="color:var(--neon); font-size:12px; font-weight:bold">0.0000 HK/s</div>
            <div id="temp-info" class="temp-badge" style="display:none">TEMP HK ACTIVE: 5:00</div>
            <div id="spent-txt" style="font-size:10px; opacity:0.4; margin-top:10px">SPENT: 0.00</div>
        </div>
        <div class="card" style="padding:15px"><input type="text" id="p-input" oninput="checkPromo()" placeholder="PROMOCODE"></div>
        <div style="overflow-y:auto; flex:1">
            <div class="card" style="display:flex; justify-content:space-between; align-items:center">
                <div style="text-align:left"><b id="m1-t">Micro</b><br><small>+0.07/h</small></div>
                <button class="btn-buy" onclick="buy(3, 0.07)">3 HK</button>
            </div>
            <div class="card" style="display:flex; justify-content:space-between; align-items:center">
                <div style="text-align:left"><b id="m2-t">Medium</b><br><small>+0.40/h</small></div>
                <button class="btn-buy" onclick="buy(15, 0.4)">15 HK</button>
            </div>
            <div class="card" style="display:flex; justify-content:space-between; align-items:center">
                <div style="text-align:left"><b id="m3-t">Hard</b><br><small>+1.50/h</small></div>
                <button class="btn-buy" onclick="buy(50, 1.5)">50 HK</button>
            </div>
            <div class="card" style="display:flex; justify-content:space-between; align-items:center; border: 1px solid var(--neon)">
                <div style="text-align:left"><b id="m4-t">ULTRA</b><br><small>+5.00/h</small></div>
                <button class="btn-buy" onclick="buy(150, 5.0)">150 HK</button>
            </div>
        </div>
    </div>

    <div id="click-screen" class="screen">
        <div class="tap-pill" onclick="tap()" style="margin-top:100px">
            <span id="target-txt" style="font-size:11px; opacity:0.5; margin-bottom:10px">GOAL: 0 / 10</span>
            <span style="font-size:36px; font-weight:900; color:var(--neon)">TAP</span>
            <div style="width:50%; height:4px; background:rgba(255,255,255,0.1); margin-top:20px; border-radius:10px; overflow:hidden">
                <div id="bar" style="width:0%; height:100%; background:var(--neon)"></div>
            </div>
        </div>
    </div>

    <div id="top-screen" class="screen">
        <div class="card" style="flex:1; margin-top:40px; overflow-y:auto">
            <h3 id="top-h">TOP 10</h3>
            <div id="leader-list"></div>
        </div>
    </div>

    <div class="nav">
        <button id="n-home" class="nav-item active" onclick="nav('home')">Home</button>
        <button id="n-click" class="nav-item" onclick="nav('click')">Tap</button>
        <button id="n-top" class="nav-item" onclick="nav('top')">Top</button>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js";
    import { getDatabase, ref, get, child, update, query, orderByChild, limitToLast } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBD-uKyTOd3iXNkisXyCkpgeXYzG4oySHM",
        authDomain: "hkos-project.firebaseapp.com",
        projectId: "hkos-project",
        databaseURL: "https://hkos-project-default-rtdb.europe-west1.firebasedatabase.app"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const tg = window.Telegram.WebApp;
    const userId = tg.initDataUnsafe?.user?.id || "dev_26";

    let hk = 0, hp = 0.02, si = 0, spent = 0, cc = 0, lang = "RU", tempUntil = 0;
    let dHk = 0; 
    const stp = [10, 25, 50, 100, 150, 200, 250];

    const i18n = {
        RU: { home: "Главная", tap: "Тап", top: "Топ", goal: "Цель", spent: "Траты", m1: "Микро", m2: "Медиум", m3: "Хард", m4: "УЛЬТРА" },
        EN: { home: "Home", tap: "Tap", top: "Top", goal: "Goal", spent: "Spent", m1: "Micro", m2: "Medium", m3: "Hard", m4: "ULTRA" },
        UA: { home: "Головна", tap: "Тап", top: "Топ", goal: "Ціль", spent: "Витрати", m1: "Мікро", m2: "Медіум", m3: "Хард", m4: "УЛЬТРА" }
    };

    window.toggleLang = () => {
        if(lang === "RU") lang = "EN"; else if(lang === "EN") lang = "UA"; else lang = "RU";
        updateUI(); save();
    };

    async function load() {
        const s = await get(child(ref(db), `users/${userId}`));
        if(s.exists()) {
            const d = s.val();
            hk = d.hk || 0; hp = d.hp || 0.02; si = d.si || 0;
            spent = d.spent || 0; cc = d.cc || 0; lang = d.lang || "RU";
            tempUntil = d.tempUntil || 0;
        }
        updateUI();
        setInterval(tick, 50); // Чаще обновление для плавности
        setInterval(save, 10000);
    }

    function tick() {
        hk += hp / 72000; // Т.к. интервал 50мс

        // Проверка временных HK
        if (tempUntil > 0 && Date.now() > tempUntil) {
            hk -= 150;
            if (hk < 0) hk = 0;
            tempUntil = 0;
            showNotif(lang === "RU" ? "Время вышло: -150 HK" : "Time's up: -150 HK");
            save();
        }

        if (tempUntil > 0) {
            document.getElementById('temp-info').style.display = 'block';
            let left = Math.round((tempUntil - Date.now()) / 1000);
            document.getElementById('temp-info').innerText = `TEMP HK: ${Math.floor(left/60)}:${(left%60).toString().padStart(2,'0')}`;
        } else {
            document.getElementById('temp-info').style.display = 'none';
        }

        // Плавная анимация
        dHk += (hk - dHk) * 0.12;
        document.getElementById('hk-num').innerText = dHk.toFixed(4);
        document.getElementById('ps-num').innerText = (hp/3600).toFixed(5) + " HK/s";
    }

    window.tap = () => {
        cc++;
        let target = stp[si] || 250;
        tg.HapticFeedback.impactOccurred('medium');
        if(cc >= target) {
            let r = 0.005 + (si * 0.005);
            hk += r; cc = 0; si++;
            showNotif("+" + r.toFixed(3) + " HKos");
        }
        updateUI();
    };

    window.buy = (cost, prod) => {
        if(hk >= cost) {
            hk -= cost; spent += cost; hp += prod;
            showNotif(lang === "RU" ? "Куплено!" : "Bought!");
            updateUI(); save();
        } else showNotif(lang === "RU" ? "Мало HK!" : "Low HK!");
    };

    function updateUI() {
        const t = i18n[lang];
        document.getElementById('lang-ind').innerText = lang;
        document.getElementById('n-home').innerText = t.home;
        document.getElementById('n-click').innerText = t.tap;
        document.getElementById('n-top').innerText = t.top;
        document.getElementById('m1-t').innerText = t.m1;
        document.getElementById('m2-t').innerText = t.m2;
        document.getElementById('m3-t').innerText = t.m3;
        document.getElementById('m4-t').innerText = t.m4;
        document.getElementById('spent-txt').innerText = `${t.spent}: ${spent.toFixed(2)}`;
        
        let target = stp[si] || 250;
        document.getElementById('target-txt').innerText = `${t.goal}: ${cc} / ${target}`;
        document.getElementById('bar').style.width = (cc/target*100) + "%";
    }

    window.checkPromo = () => {
        let v = document.getElementById('p-input').value.trim().toLowerCase();
        if(v === "/imadminsoleg" && tempUntil === 0) {
            hk += 150;
            tempUntil = Date.now() + 300000; // 5 минут
            document.getElementById('p-input').value = "";
            showNotif("+150 HK (на 5 минут)");
            save();
        }
    };

    function showNotif(txt) {
        const n = document.getElementById('notif');
        n.innerText = txt; n.classList.add('show');
        setTimeout(() => n.classList.remove('show'), 3000);
    }

    window.nav = (s) => {
        document.querySelectorAll('.screen').forEach(e => e.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(e => e.classList.remove('active'));
        document.getElementById(s + '-screen').classList.add('active');
        document.getElementById('n-' + s).classList.add('active');
        if(s === 'top') loadTop();
        tg.HapticFeedback.selectionChanged();
    };

    async function loadTop() {
        const q = query(ref(db, 'users'), orderByChild('hk'), limitToLast(10));
        const s = await get(q);
        const list = document.getElementById('leader-list');
        list.innerHTML = "";
        let a = []; s.forEach(c => a.push(c.val()));
        a.sort((x,y) => y.hk - x.hk).forEach((u, i) => {
            list.innerHTML += `<div class="leader-row"><span>#${i+1} ${u.anon || 'Anon'}</span><b>${Number(u.hk).toFixed(2)}</b></div>`;
        });
    }

    function save() {
        update(ref(db, `users/${userId}`), {
            hk: hk, hp: hp, si: si, spent: spent, cc: cc, lang: lang, tempUntil: tempUntil, anon: "ID_"+String(userId).slice(0,5), lv: Date.now()
        });
    }

    const cv = document.getElementById('matrix'), cx = cv.getContext('2d');
    cv.width = window.innerWidth; cv.height = window.innerHeight;
    const dr = Array(Math.floor(cv.width/20)).fill(1);
    function draw() {
        cx.fillStyle = "rgba(0,0,0,0.15)"; cx.fillRect(0,0,cv.width,cv.height);
        cx.fillStyle = "rgba(255,255,255,0.1)"; cx.font = "12px monospace";
        dr.forEach((y, i) => {
            cx.fillText(["HK", "#", "0", "1"][Math.floor(Math.random()*4)], i*20, y*20);
            if(y*20 > cv.height && Math.random() > 0.98) dr[i] = 0;
            dr[i]++;
        });
    }
    setInterval(draw, 100);
    load();
</script>
</body>
    </html>
